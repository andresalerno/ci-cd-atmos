name: CI Pipeline (Lint, Test, Build)

on:
  # Gatilho para o CI rodar quando houver push ou pull request para a branch main
  push:
    branches:
      - main  # Executa quando há push para a branch principal (main)
  pull_request:
    branches:
      - main  # Executa quando há pull request para a branch principal (main)
  # Permite disparar manualmente pelo UI do GitHub
  workflow_dispatch:

jobs:
  # Job de Linting para o Backend
  backend-lint:
    runs-on: ubuntu-latest  # Usa a última versão do Ubuntu disponível para execução
    defaults:
      run:
        working-directory: backend  # Define o diretório de trabalho como 'backend'

    steps:
      # Passo 1: Checkout do código
      - uses: actions/checkout@v4
        name: Checkout code

      # Passo 2: Configuração do Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: 18  # Define a versão do Node.js
          cache: 'npm'  # Ativa cache para dependências npm
          cache-dependency-path: backend/package.json  # Usa arquivo existente para chave do cache

      # Passo 3: Instalar dependências
      - name: Install
        run: |
          # Tenta instalação reprodutível (npm ci); se falhar por devDeps novos, faz npm i
          if [ -f package-lock.json ]; then npm ci || npm i --no-audit --no-fund; else npm i --no-audit --no-fund; fi

      # Passo 4: Rodar Lint (verificação de qualidade de código)
      - name: Lint
        run: npm run lint

  # Unit tests para o Backend
  backend-unit-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4
        name: Checkout code

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: backend/package.json

      - name: Install
        run: |
          if [ -f package-lock.json ]; then npm ci || npm i --no-audit --no-fund; else npm i --no-audit --no-fund; fi

      - name: Unit Test
        run: npm run test:unit

      - name: Upload backend unit test reports (JUnit)
        uses: actions/upload-artifact@v4
        with:
          name: backend-unit-tests-junit-${{ github.run_number }}
          path: |
            backend/reports/**/*.xml
            backend/test-results/**/*.xml
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload backend unit coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-unit-coverage-${{ github.run_number }}
          path: backend/coverage/**
          if-no-files-found: ignore
          retention-days: 14

  # Integration tests para o Backend
  backend-integration-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4
        name: Checkout code

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: backend/package.json

      - name: Install
        run: |
          if [ -f package-lock.json ]; then npm ci || npm i --no-audit --no-fund; else npm i --no-audit --no-fund; fi

      - name: Integration Test
        run: npm run test:integration

      - name: Upload backend integration test reports (JUnit)
        uses: actions/upload-artifact@v4
        with:
          name: backend-integration-tests-junit-${{ github.run_number }}
          path: |
            backend/reports/**/*.xml
            backend/test-results/**/*.xml
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload backend integration coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-integration-coverage-${{ github.run_number }}
          path: backend/coverage/**
          if-no-files-found: ignore
          retention-days: 14

  # Job de Build para o Backend
  backend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend  # Define o diretório de trabalho como 'backend'

    steps:
      - uses: actions/checkout@v4
        name: Checkout code

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: backend/package.json

      - name: Install
        run: |
          if [ -f package-lock.json ]; then npm ci || npm i --no-audit --no-fund; else npm i --no-audit --no-fund; fi

      # Passo 3: Build (Noop aqui, pode ser ajustado para um verdadeiro build)
      - name: Build (noop for backend)
        run: echo "no build step"  # No-op: sem build real para o backend, mas pode ser ajustado se necessário

      - name: Package backend artifact
        run: |
          tar -czf backend-artifact-${GITHUB_RUN_NUMBER}.tar.gz \
            package.json package-lock.json Dockerfile src || echo "nothing to package?"

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-artifact-${{ github.run_number }}
          path: backend/backend-artifact-${{ github.run_number }}.tar.gz
          if-no-files-found: ignore
          retention-days: 14

  # Job de Linting para o Frontend
  frontend-lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend  # Define o diretório de trabalho como 'frontend'

    steps:
      - uses: actions/checkout@v4
        name: Checkout code

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Install
        run: |
          if [ -f package-lock.json ]; then npm ci || npm i --no-audit --no-fund; else npm i --no-audit --no-fund; fi

      # Passo 4: Rodar Lint no frontend
      - name: Lint
        run: npm run lint

  # Job de Testes para o Frontend
  frontend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend  # Define o diretório de trabalho como 'frontend'

    steps:
      - uses: actions/checkout@v4
        name: Checkout code

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Install
        run: |
          if [ -f package-lock.json ]; then npm ci || npm i --no-audit --no-fund; else npm i --no-audit --no-fund; fi

      # Passo 5: Rodar Testes no frontend
      - name: Test
        run: npm test

      - name: Upload frontend test reports (JUnit)
        uses: actions/upload-artifact@v4
        with:
          name: frontend-tests-junit-${{ github.run_number }}
          path: |
            frontend/reports/**/*.xml
            frontend/test-results/**/*.xml
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-${{ github.run_number }}
          path: frontend/coverage/**
          if-no-files-found: ignore
          retention-days: 14

  # Job de Build para o Frontend
  frontend-build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend  # Define o diretório de trabalho como 'frontend'

    steps:
      - uses: actions/checkout@v4
        name: Checkout code

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Install
        run: |
          if [ -f package-lock.json ]; then npm ci || npm i --no-audit --no-fund; else npm i --no-audit --no-fund; fi

      # Passo 6: Build do frontend
      - name: Build
        run: npm run build

      # Publica o build do frontend como artefato do workflow (para download)
      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-${{ github.run_number }}
          path: frontend/dist
          if-no-files-found: ignore
          retention-days: 14

  # Job de Sumário do Build: mostra status de todos os jobs e metadados do run
  summary:
    needs:
      - backend-lint
      - backend-unit-test
      - backend-integration-test
      - backend-build
      - frontend-lint
      - frontend-test
      - frontend-build
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Publicar resumo do build
        run: |
          {
            echo "## Resumo do Build";
            echo "- Run: $GITHUB_RUN_NUMBER";
            echo "- Workflow: $GITHUB_WORKFLOW";
            echo "- Commit: $GITHUB_SHA";
            echo "- Ref: $GITHUB_REF";
            echo "- Ator: $GITHUB_ACTOR";
            echo "- Data (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')";
            echo "";
            echo "### Status dos Jobs";
            echo "- backend-lint: ${{ needs['backend-lint'].result }}";
            echo "- backend-unit-test: ${{ needs['backend-unit-test'].result }}";
            echo "- backend-integration-test: ${{ needs['backend-integration-test'].result }}";
            echo "- backend-build: ${{ needs['backend-build'].result }}";
            echo "- frontend-lint: ${{ needs['frontend-lint'].result }}";
            echo "- frontend-test: ${{ needs['frontend-test'].result }}";
            echo "- frontend-build: ${{ needs['frontend-build'].result }}";
          } >> "$GITHUB_STEP_SUMMARY"

  # Atualiza o README com data/hora e ator da última execução do CI
  update-readme-meta:
    needs:
      - backend-lint
      - backend-unit-test
      - backend-integration-test
      - backend-build
      - frontend-lint
      - frontend-test
      - frontend-build
      - summary
    if: ${{ always() && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          persist-credentials: true
      - name: Update README meta block
        env:
          RUN_NUMBER: ${{ github.run_number }}
          ACTOR: ${{ github.actor }}
          SHA: ${{ github.sha }}
          REF_NAME: ${{ github.ref_name }}
          RES_BACKEND_LINT: ${{ needs['backend-lint'].result }}
          RES_BACKEND_UNIT_TEST: ${{ needs['backend-unit-test'].result }}
          RES_BACKEND_INTEGRATION_TEST: ${{ needs['backend-integration-test'].result }}
          RES_BACKEND_BUILD: ${{ needs['backend-build'].result }}
          RES_FRONTEND_LINT: ${{ needs['frontend-lint'].result }}
          RES_FRONTEND_TEST: ${{ needs['frontend-test'].result }}
          RES_FRONTEND_BUILD: ${{ needs['frontend-build'].result }}
        run: |
          set -euo pipefail
          DATE_UTC=$(date -u '+%Y-%m-%d %H:%M:%S')
          OVERALL="success"
          for r in "$RES_BACKEND_LINT" "$RES_BACKEND_UNIT_TEST" "$RES_BACKEND_INTEGRATION_TEST" "$RES_BACKEND_BUILD" "$RES_FRONTEND_LINT" "$RES_FRONTEND_TEST" "$RES_FRONTEND_BUILD"; do
            if [ "$r" != "success" ]; then OVERALL="$r"; break; fi
          done
          NEWLINE="Última execução do CI: ${DATE_UTC} UTC • ator: ${ACTOR} • branch: ${REF_NAME} • status: ${OVERALL} (run #${RUN_NUMBER})"
          awk -v repl="$NEWLINE" '
            BEGIN{inb=0}
            /<!-- ci-meta-start -->/{print; print repl; inb=1; next}
            /<!-- ci-meta-end -->/{inb=0}
            !inb{print}
          ' README.md > README.md.new

          # Atualiza badge dinâmico (Shields endpoint) em .badges/ci-meta.json
          mkdir -p .badges
          case "$OVERALL" in
            success) COLOR="brightgreen" ;;
            failure) COLOR="red" ;;
            cancelled) COLOR="yellow" ;;
            *) COLOR="lightgrey" ;;
          esac
          MESSAGE="${OVERALL} — ${DATE_UTC} UTC • ${ACTOR}"
          cat > .badges/ci-meta.json <<JSON
          {"schemaVersion":1,"label":"ci","message":"${MESSAGE}","color":"${COLOR}","cacheSeconds":60}
          JSON

          if ! cmp -s README.md README.md.new; then
            mv README.md.new README.md
            CHANGED=1
          else
            rm -f README.md.new
            CHANGED=0
          fi

          git config user.email "ci-bot@example.com"
          git config user.name "CI Setup Bot"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git pull --rebase || true
          git add .badges/ci-meta.json || true
          if [ "$CHANGED" -eq 1 ] || ! git diff --cached --quiet; then
            git commit -m "docs: update CI meta and badge [skip ci]" || echo "Nothing to commit"
            git push
          else
            echo "No README or badge changes"
          fi
